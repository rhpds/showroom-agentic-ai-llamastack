{{#if site.keys.aiAssistantEnabled}}
<!-- AI Chatbot Integration -->
<div id="ai-assistant-widget-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
  <button id="ai-assistant-widget-toggle" style="
    background: #0066cc;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 20px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Red Hat Text', sans-serif;
    font-size: 14px;
    font-weight: 500;
  " onmouseover="this.style.background='#0052a3'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 0, 0, 0.2)'" onmouseout="this.style.background='#0066cc'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <span id="ai-assistant-widget-label">AI Assistant</span>
  </button>

  <div id="ai-assistant-widget-window" style="
    position: absolute;
    bottom: 70px;
    right: 0;
    width: 650px;
    height: calc(100vh - 100px);
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    display: none;
    flex-direction: column;
    border: 1px solid #e1e5e9;
  ">
    <div style="
      background: #0066cc;
      color: white;
      padding: 16px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: 'Red Hat Text', sans-serif;
    ">
      <div style="display: flex; align-items: center; gap: 10px; pointer-events: none;">
        <img src="{{uiRootPath}}/img/favicon.ico" alt="Logo" style="width: 24px; height: 24px;">
        <h3 style="margin: 0; font-size: 16px; font-weight: 500; color: white;">AI Assistant</h3>
      </div>
      <div style="display: flex; align-items: center; gap: 12px;">
        <a href="/ai-assistant/index.html" target="_blank" rel="noopener noreferrer" style="
          background: transparent;
          border: none;
          color: white;
          cursor: pointer;
          font-size: 18px;
          padding: 0;
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          text-decoration: none;
          transition: opacity 0.2s;
        " title="Open AI Assistant in a new tab" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
          ⧉
        </a>
        <button id="ai-assistant-close-btn" style="
          background: transparent;
          border: none;
          color: white;
          cursor: pointer;
          font-size: 20px;
          padding: 0;
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
        " title="Close">
          ✕
        </button>
      </div>
    </div>
    <iframe
      src="/ai-assistant/index.html"
      style="width: 100%; flex: 1; border: none;"
      title="AI Lab Assistant"
    ></iframe>
  </div>
</div>

<script>
(function() {
  console.log('AI Assistant widget initializing...');
  const toggle = document.getElementById('ai-assistant-widget-toggle');
  const chatbotWindow = document.getElementById('ai-assistant-widget-window');
  const label = document.getElementById('ai-assistant-widget-label');
  const closeBtn = document.getElementById('ai-assistant-close-btn');

  console.log('Toggle button:', toggle);
  console.log('Assistant window:', chatbotWindow);

  // Persist open/closed state in localStorage
  const STORAGE_KEY_IS_OPEN = 'ai-assistant-is-open';
  let isOpen = localStorage.getItem(STORAGE_KEY_IS_OPEN) === 'true';

  function closeWindow() {
    isOpen = false;
    localStorage.setItem(STORAGE_KEY_IS_OPEN, 'false');
    chatbotWindow.style.display = 'none';
    if (label) {
      label.textContent = 'AI Assistant';
    }
    console.log('Window closed');
  }

  function openWindow() {
    isOpen = true;
    localStorage.setItem(STORAGE_KEY_IS_OPEN, 'true');
    chatbotWindow.style.display = 'flex';
    if (label) {
      label.textContent = 'Close';
    }
    console.log('Window opened');
  }

  if (toggle && chatbotWindow) {
    // Restore previous state on page load
    if (isOpen) {
      openWindow();
    }

    toggle.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Toggle clicked! Current state:', isOpen);
      if (isOpen) {
        closeWindow();
      } else {
        openWindow();
      }
    });

    if (closeBtn) {
      closeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Close button clicked');
        closeWindow();
      });
    }

    console.log('Event listeners attached successfully');
  } else {
    console.error('Could not find toggle or window elements!');
  }
})();
</script>
{{/if}}
