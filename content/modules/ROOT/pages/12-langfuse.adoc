= Langfuse: Traces, Evals and Feedback

Agents are applications and need the appropriate infrastructure to run them at with scale.  Many of the vital capabilities such as load-balancing and fail-over across replicas, capturing logs and metrics and automatic restart are part of OpenShift.

However, Agents do have some unique aspects that require additional infrastructure services such as:

* Traces
* Evals
* Feedback 

The open source solution for these capabilities is in *Langfuse*.  

Traces are mission critical for debugging, production support and for the intial capture of end-user intent and subsequent creation of evals.
Feedback is vital to incrementally improving the quality of your agent over time. 

== Langfuse Setup 

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
helm repo add langfuse https://langfuse.github.io/langfuse-k8s
helm repo update
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
LF_SALT="$(openssl rand -hex 16)"
LF_NEXTAUTH_SECRET="$(openssl rand -hex 32)"
PG_PASS="$(openssl rand -hex 16)"
CH_PASS="$(openssl rand -hex 16)"
REDIS_PASS="$(openssl rand -hex 16)"
S3_ROOT_PASS="$(openssl rand -hex 16)"
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
oc create secret generic langfuse-general \
  --from-literal=salt="$LF_SALT"

oc create secret generic langfuse-nextauth-secret \
  --from-literal=nextauth-secret="$LF_NEXTAUTH_SECRET"

oc create secret generic langfuse-postgresql-auth \
  --from-literal=password="$PG_PASS" \
  --from-literal=postgres-password="$PG_PASS"

oc create secret generic langfuse-clickhouse-auth \
  --from-literal=password="$CH_PASS"

oc create secret generic langfuse-redis-auth \
  --from-literal=password="$REDIS_PASS"

oc create secret generic langfuse-s3-auth \
  --from-literal=rootUser="root" \
  --from-literal=rootPassword="$S3_ROOT_PASS"
----


[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
helm install langfuse langfuse/langfuse -f https://raw.githubusercontent.com/burrsutter/fantaco-redhat-one-2026/main/langfuse-setup/values-openshift.yaml
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
oc get pods
----

[.console-output]
[source,bash,subs=attributes+]
----
NAME                                           READY   STATUS             RESTARTS      AGE
fantaco-customer-main-7fd4ddb666-vvt7s         1/1     Running            0             139m
fantaco-finance-main-75ffddb44b-6cbqz          1/1     Running            0             139m
langfuse-clickhouse-shard0-0                   1/1     Running            0             5m9s
langfuse-clickhouse-shard0-1                   1/1     Running            0             5m9s
langfuse-clickhouse-shard0-2                   1/1     Running            0             5m9s
langfuse-postgresql-0                          1/1     Running            0             5m9s
langfuse-redis-primary-0                       1/1     Running            0             5m9s
langfuse-s3-5fb6c8f845-lznsd                   1/1     Running            0             5m9s
langfuse-web-b4b9574bf-kxkjw                   0/1     CrashLoopBackOff   4 (69s ago)   5m9s
langfuse-worker-7dddc7875-87mkj                0/1     CrashLoopBackOff   5 (57s ago)   5m9s
langfuse-zookeeper-0                           1/1     Running            0             5m9s
langfuse-zookeeper-1                           1/1     Running            0             5m9s
langfuse-zookeeper-2                           1/1     Running            0             5m9s
langgraph-fastapi-569d6d554-szcm8              1/1     Running            0             7m31s
llamastack-distribution-vllm-84566485f-sxmvt   1/1     Running            0             155m
mcp-customer-6bd8bcfc7b-926v9                  1/1     Running            0             137m
mcp-finance-8cc684b8d-ptknw                    1/1     Running            0             137m
postgresql-customer-ff78dffdf-mzp8j            1/1     Running            0             139m
postgresql-finance-689d97894f-rv86s            1/1     Running            0             139m
simple-agent-chat-ui-6d7794dc6b-xjq6w          1/1     Running            0             7m31s
----

The *CrashLoopBackOff* is expected at this stage of the flow.  The next set of steps correct this problem. 



[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
oc expose service langfuse-web
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
oc patch route langfuse-web -p '{"spec":{"tls":{"termination":"edge","insecureEdgeTerminationPolicy":"Redirect"}}}'
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
export LANGFUSE_URL="https://$(oc get route -l app.kubernetes.io/name=langfuse -o jsonpath='{.items[0].spec.host}')"
echo $LANGFUSE_URL
----

[.console-output]
[source,bash,subs=attributes+]
----
http://langfuse-web-langfuse.apps.cluster-2qn7j.dynamic.redhatworkshops.io
----

You need to update the values-openshift.yaml.  The URL is used instead of Langfuse during the end-user sign-up process.  It will default to "localhost:3000" without this additional setting.

[.console-output]
[source,bash,subs=attributes+]
----
  langfuse:
    nextauth:
      url: "PLACEHOLDER_URL"
----


[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
cd $HOME/fantaco-redhat-one-2026/langfuse-setup
pwd
----

[.console-output]
[source,bash,subs=attributes+]
----
/home/lab-user/fantaco-redhat-one-2026/langfuse-setup
----

MacOS

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
sed -i '' "s|PLACEHOLDER_URL|$LANGFUSE_URL|g" values-openshift.yaml
----

Linux

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
sed -i "s|PLACEHOLDER_URL|$LANGFUSE_URL|g" values-openshift.yaml
----


Then update the deployment


[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
helm upgrade langfuse langfuse/langfuse -f values-openshift.yaml
----

[.console-output]
[source,bash,subs=attributes+]
----
Release "langfuse" has been upgraded. Happy Helming!
NAME: langfuse
LAST DEPLOYED: Fri Jan  2 12:16:51 2026
NAMESPACE: langfuse
STATUS: deployed
REVISION: 2
DESCRIPTION: Upgrade complete
TEST SUITE: None
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
oc rollout restart deployment langfuse-web
----

[.console-output]
[source,bash,subs=attributes+]
----
deployment.apps/langfuse-web restarted
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
oc get pods
----

[.console-output]
[source,bash,subs=attributes+]
----
NAME                                           READY   STATUS    RESTARTS   AGE
fantaco-customer-main-7fd4ddb666-vvt7s         1/1     Running   0          144m
fantaco-finance-main-75ffddb44b-6cbqz          1/1     Running   0          144m
langfuse-clickhouse-shard0-0                   1/1     Running   0          10m
langfuse-clickhouse-shard0-1                   1/1     Running   0          10m
langfuse-clickhouse-shard0-2                   1/1     Running   0          10m
langfuse-postgresql-0                          1/1     Running   0          10m
langfuse-redis-primary-0                       1/1     Running   0          10m
langfuse-s3-5fb6c8f845-lznsd                   1/1     Running   0          10m
langfuse-web-694c8bc4fc-qxfqh                  1/1     Running   0          3m51s
langfuse-worker-7ff84dd6c-f99c2                1/1     Running   0          3m51s
langfuse-zookeeper-0                           1/1     Running   0          10m
langfuse-zookeeper-1                           1/1     Running   0          10m
langfuse-zookeeper-2                           1/1     Running   0          10m
langgraph-fastapi-569d6d554-szcm8              1/1     Running   0          13m
llamastack-distribution-vllm-84566485f-sxmvt   1/1     Running   0          161m
mcp-customer-6bd8bcfc7b-926v9                  1/1     Running   0          142m
mcp-finance-8cc684b8d-ptknw                    1/1     Running   0          142m
postgresql-customer-ff78dffdf-mzp8j            1/1     Running   0          144m
postgresql-finance-689d97894f-rv86s            1/1     Running   0          144m
simple-agent-chat-ui-6d7794dc6b-xjq6w          1/1     Running   0          13m
----


[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
echo $LANGFUSE_URL
echo "Open in a new browser tab"
----

Based on the URL to the GUI of Langfuse then create the following:

* Account
* Organization
* Project
* API Keys

Click *Sign up*


image::langfuse-login-1.png[]

Provide name, email address and password and click *Sign up*

image::langfuse-sign-up-1.png[]

Click *New Organization*

image::langfuse-sign-up-2.png[]

Provide an organization name of *my-agent-org* and click *Create*

image::langfuse-sign-up-3.png[]

Click *Next*

image::langfuse-sign-up-4.png[]

Provide a project name of *my-agent-project* and click *Create*

image::langfuse-sign-up-5.png[]

Click on *Settings*

image::langfuse-sign-up-6.png[]

Click on *API Keys* 

image::langfuse-sign-up-7.png[]

Click on *+ Create new API Keys*

image::langfuse-sign-up-8.png[]

Provide a key name of *my-key* and click *Create API keys*

image::langfuse-sign-up-9.png[]

You will need the *.env* variables.  

image::langfuse-sign-up-10.png[]

You will need to update your *.env* with the 3 values from LangFuse


Note: LANGFUSE_BASE_URL is now *LANGFUSE_HOST*


Make sure you are in the correct base directory

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
cd $HOME/fantaco-redhat-one-2026/
pwd
----

[.console-output]
[source,bash,subs=attributes+]
----
/home/lab-user/fantaco-redhat-one-2026
----

Check that you have set key env variables

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
export LLAMA_STACK_BASE_URL=http://llamastack-distribution-vllm-service.agentic-{user}.svc:8321
export INFERENCE_MODEL=vllm/qwen3-14b
echo "LLAMA_STACK_BASE_URL="$LLAMA_STACK_BASE_URL
echo "INFERENCE_MODEL="$INFERENCE_MODEL
----

[.console-output]
[source,bash,subs=attributes+]
----
LLAMA_STACK_BASE_URL=http://llamastack-distribution-vllm-service:8321
INFERENCE_MODEL=vllm/qwen3-14b
----



If needed, create a Python virtual environment (venv) 

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
python -m venv .venv
----

or you can look for an existing .venv folder

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
ls .venv
----

The following response indicates you need to create your Python venv

[.console-output]
[source,bash,subs=attributes+]
----
ls: cannot access '.venv': No such file or directory
----

and 

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
echo $VIRTUAL_ENV
----

[.console-output]
[source,bash,subs=attributes+]
----
/home/lab-user/fantaco-redhat-one-2026/.venv
----

Set environment

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
source .venv/bin/activate 
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
cd $HOME/fantaco-redhat-one-2026/langfuse-setup/langgraph-agent/backend
ls -la
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
cp .env.example .env
----


Either export the appropriate Langfuse env variables or add to your newly created .env file

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
# Langfuse configuration
export LANGFUSE_PUBLIC_KEY=pk-lf-xxx
export LANGFUSE_SECRET_KEY=sk-lf-xxx
export LANGFUSE_HOST=https://cloud.langfuse.com
----

Or

image::RHOAI-workbench-env-edit-langfuse.png[]


[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
# LangGraph and LLama Stack configuration
export API_KEY=not-applicable
----

And double check on your MCP server URLs


[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
export CUSTOMER_MCP_SERVER_URL=https://$(oc get routes -l app=mcp-customer -o jsonpath="{range .items[*]}{.status.ingress[0].host}{end}")/mcp
export FINANCE_MCP_SERVER_URL=https://$(oc get routes -l app=mcp-finance -o jsonpath="{range .items[*]}{.status.ingress[0].host}{end}")/mcp
echo $CUSTOMER_MCP_SERVER_URL
echo $FINANCE_MCP_SERVER_URL
----


== Test the agent

Terminal 1

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
cd $HOME/fantaco-redhat-one-2026/langfuse-setup/langgraph-agent/backend
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
pip install -r requirements.txt
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
python 6-langgraph-langfuse-fastapi-chatbot.py
----

[.console-output]
[source,bash,subs=attributes+]
----
2026-01-01 17:47:18,114 - __main__ - INFO - Starting FastAPI server on port 8002...
INFO:     Started server process [190]
INFO:     Waiting for application startup.
2026-01-01 17:47:18,167 - __main__ - INFO - Initializing MCP clients...
2026-01-01 17:47:18,374 - mcp.client.streamable_http - INFO - Received session ID: f551c9b09df343f1ad85ebd3b67dee48
2026-01-01 17:47:18,376 - mcp.client.streamable_http - INFO - Negotiated protocol version: 2025-06-18
2026-01-01 17:47:18,522 - mcp.client.streamable_http - INFO - Received session ID: 6d9eee0561334c05833355a3f9ac75e7
2026-01-01 17:47:18,524 - mcp.client.streamable_http - INFO - Negotiated protocol version: 2025-06-18
2026-01-01 17:47:18,599 - __main__ - INFO - MCP clients initialized. Available tools: ['search_customers', 'get_customer', 'fetch_order_history', 'fetch_invoice_history']
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8002 (Press CTRL+C to quit)
----

Terminal 2

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
curl -sS -X POST http://localhost:8002/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "who does Thomas Hardy work for?",
    "user_id": "test-user",
    "session_id": "test-session-123"
}' | jq -r '.reply'
----

[.console-output]
[source,bash,subs=attributes+]
----
Thomas Hardy works for **Around the Horn** as a **Sales Representative**. 

Let me know if you need additional details about this customer!
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
curl -sS -X POST http://localhost:8002/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "what are Fran Wilson'\''s orders?",
    "user_id": "test-user",
    "session_id": "test-session-123"
}' | jq -r '.reply'
----

[.console-output]
[source,bash,subs=attributes+]
----
Fran Wilson (LONEP) has 3 orders:

1. **ORD-006** (Jan 5, 2024) - DELIVERED $399.99  
2. **ORD-001** (Jan 15, 2024) - DELIVERED $299.99  
3. **ORD-002** (Jan 20, 2024) - SHIPPED $149.50  

Would you like details about any specific order or invoice history?
----

== Traces

Find the traces inside of Langfuse

image::langfuse-thomas-hardy.png[]

image::langfuse-fran-wilson.png[]


The following requires *cluster admin* - your instructor can create the route for you

Open a Route to the GUI 

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
./create-workbench-8002-route.sh
----

[.console-output]
[source,bash,subs=attributes+]
----
Using namespace: agentic-user1
Target user: user1
Creating Service and Route for port 8002...
Host will be: https://workbench-8002-agentic-user1.apps.cluster-b8h97.dynamic.redhatworkshops.io
service/workbench-8002 created
route.route.openshift.io/workbench-8002 created
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
export CHAT_TRACES_URL="https://$(oc get route workbench-8002 -o jsonpath='{.spec.host}')"
echo $CHAT_TRACES_URL
----

[.console-output]
[source,bash,subs=attributes+]
----
https://workbench-8002-agentic-user1.apps.cluster-b8h97.dynamic.redhatworkshops.io
----

image:langfuse-chat-ui-1.png[]

image:langfuse-liu-wong-1.png[]

== Evals

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
curl -sS -X POST http://localhost:8002/evaluate \
  -H "Content-Type: application/json" \
  -d '{
    "run_name": "after-prompt-update",
    "sync_dataset": true,
    "record_to_langfuse": true
  }' | jq .
----

[.console-output]
[source,bash,subs=attributes+]
----
{
  "run_name": "after-prompt-update",
  "timestamp": "2026-01-03T22:52:48.068633",
  "dataset_name": "customer-service-eval",
  "total_tests": 3,
  "passed": 3,
  "failed": 0,
  "pass_rate": 1.0,
  "average_score": 1.0,
  "duration_ms": 42144.819498062134,
  "results": [
    {
      "test_id": "thomas-hardy-company-job",
      "test_name": "Thomas Hardy Company and Job Query",
      "passed": true,
      "score": 1.0,
      "response": "\n\nThomas Hardy works for **Around the Horn** and his job title is **Sales Representative**. \n\nLet me know if you need additional details!",
      "trace_id": "ccbdd39f31ad0046995c2df51872d7ea",
      "matched_keywords": [
        "Around the Horn",
        "Sales Representative"
      ],
      "missing_keywords": [],
      "details": "Matched 2/2 keywords",
      "duration_ms": 8468.608140945435
    },
    {
      "test_id": "lonesome-pine-contact",
      "test_name": "Lonesome Pine Contact Query",
      "passed": true,
      "score": 1.0,
      "response": "\n\nThe primary contact for **Lonesome Pine Restaurant** is **Fran Wilson**, the Sales Manager. Hereâ€™s how to reach them:\n\n- **Phone:** (503) 555-9573  \n- **Email:** franwilson@example.com  \n\nLet me know if you need additional details!",
      "trace_id": "ccbdd39f31ad0046995c2df51872d7ea",
      "matched_keywords": [
        "Fran Wilson",
        "(503) 555-9573",
        "franwilson@example.com"
      ],
      "missing_keywords": [],
      "details": "Matched 3/3 keywords",
      "duration_ms": 10165.385484695435
    },
    {
      "test_id": "fran-wilson-delivered-orders",
      "test_name": "Fran Wilson Delivered Orders Query",
      "passed": true,
      "score": 1.0,
      "response": "\n\nHere are the delivered orders for Fran Wilson (LONEP):\n\n1. **Order #ORD-001**  \n   - Date: January 15, 2024  \n   - Total: $299.99  \n\n2. **Order #ORD-006**  \n   - Date: January 5, 2024  \n   - Total: $399.99  \n\n**Total delivered orders:** 2  \n*(Note: One additional order, ORD-002, is marked as \"SHIPPED\" but not yet delivered.)*  \n\nLet me know if you need further details!",
      "trace_id": "ccbdd39f31ad0046995c2df51872d7ea",
      "matched_keywords": [
        "ORD-001",
        "$299.99",
        "ORD-006",
        "$399.99"
      ],
      "missing_keywords": [],
      "details": "Matched 4/4 keywords",
      "duration_ms": 23384.660720825195
    }
  ]
}
----

image:langfuse-datasets-1.png[]

image::langfuse-scores-1.png[]

image::langfuse-fran-wilson-delivered-orders-1.png[]



== Feedback


image::feedback-1.png[]

image::langfuse-scores-feedback-comment-1.png[]

image::langfuse-scores-feedback-comment-2.png[]

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
./list-traces.sh
----

[.console-output]
[source,bash,subs=attributes+]
----
Fetching last 10 traces...

TRACE ID                           QUERY
=====================================================================================
bc0008ba64304e09fcc3fbaf9f1f9888   what is today?
20a4d01e6cf0eb28e15872a5317274a2   who is Burr Sutter?
1e81a8782d937c8e1adafb994e96681c   what are the delivered orders for Fran Wilson?
dd4e1cb37e83e51e3d25bd05cc237f16   who is the primary contact for Lonesome Pine ...
631fc657a05762b86e44551393fb16f1   who does Thomas Hardy work for and what is hi...
4e4ed7ee062f0d38f0abb6fc03defc3d   what are the orders for Liu Wong?
017c454bb7fbc01cc5a7a8fe6f0b073b   who does Thomas Hardy work for?
8fa62c42a85d8f14ba9a42d38359ce53   what are Fran Wilson's orders?
5ee044f92e94fd50c133f5ac7dc82d96   who does Thomas Hardy work for?
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
./get-trace-feedback.sh bc0008ba64304e09fcc3fbaf9f1f9888
----

[.console-output]
[source,bash,subs=attributes+]
----
./get-trace-feedback.sh bc0008ba64304e09fcc3fbaf9f1f9888

Fetching trace: bc0008ba64304e09fcc3fbaf9f1f9888
================================================
Name: customer-service-chat
Timestamp: 2026-01-08T17:57:16.111Z
Input: what is today?
Output:

I don't have access to real-time information or calendar functions. You'll need to check your device's clock or a calendar application for today's date. Let me know if you need help with any custome...

Feedback:
---------
  Score: thumbs down (0)
  Comment: you should have access to a clock~!
  Time: 2026-01-08T17:57:35.580Z
----

== Llama Stack integration


[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
cd fantaco-redhat-one-2026/llama-stack-scripts
./update-llamastack-langfuse.sh <LANGFUSE_SECRET_KEY> <LANGFUSE_PUBLIC_KEY> <LANGFUSE_HOST>
----

And watch for the pod to update

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
oc get pods -l app=llama-stack
----





