= Langfuse: Traces, Evals and Feedback

Agents are applications and need the appropriate infrastructure to run them at with scale.  Many of the vital capabilities such as load-balancing and fail-over across replicas, capturing logs and metrics and automatic restart are part of OpenShift.

However, Agents do have some unique aspects that require additional infrastructure services such as:

* Traces
* Evals
* Feedback 

The open source solution for these capabilities is in *Langfuse*.  

Traces are mission critical for debugging, production support and for the intial capture of end-user intent and subsequent creation of evals.
Feedback is vital to incrementally improving the quality of your agent over time. 

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
cd $HOME/fantaco-redhat-one-2026/
pwd
----

[.console-output]
[source,bash,subs=attributes+]
----
/home/lab-user/fantaco-redhat-one-2026
----

Check that you have set key env variables

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
export LLAMA_STACK_BASE_URL=http://llamastack-distribution-vllm-service.agentic-{user}.svc:8321
export INFERENCE_MODEL=vllm/qwen3-14b
echo "LLAMA_STACK_BASE_URL="$LLAMA_STACK_BASE_URL
echo "INFERENCE_MODEL="$INFERENCE_MODEL
----

[.console-output]
[source,bash,subs=attributes+]
----
LLAMA_STACK_BASE_URL=http://llamastack-distribution-vllm-service:8321
INFERENCE_MODEL=vllm/qwen3-14b
----

LangGraph clients (and most clients) like having an API_KEY set, even if it is not applicable since we are using privately hosted models via Llama Stack.

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
export API_KEY=not-applicable
----

And double check on your MCP server URLs


[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
export CUSTOMER_MCP_SERVER_URL=https://$(oc get routes -l app=mcp-customer -o jsonpath="{range .items[*]}{.status.ingress[0].host}{end}")/mcp
export FINANCE_MCP_SERVER_URL=https://$(oc get routes -l app=mcp-finance -o jsonpath="{range .items[*]}{.status.ingress[0].host}{end}")/mcp
echo $CUSTOMER_MCP_SERVER_URL
echo $FINANCE_MCP_SERVER_URL
----



If needed, create a Python virtual environment (venv) 

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
python -m venv .venv
----

or you can look for an existing .venv folder

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
ls .venv
----

The following response indicates you need to create your Python venv

[.console-output]
[source,bash,subs=attributes+]
----
ls: cannot access '.venv': No such file or directory
----

and 

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
echo $VIRTUAL_ENV
----

[.console-output]
[source,bash,subs=attributes+]
----
/home/lab-user/fantaco-redhat-one-2026/.venv
----

If needed, set environment to point to the venv

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
source .venv/bin/activate 
----

Now change to the agent backend directory.  We have another LangGraph-based agent that has been instrumented for Langfuse traces.

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
cd $HOME/fantaco-redhat-one-2026/langfuse-setup
----

== Langfuse Setup 

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
source ./create-langfuse-url.sh
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
source ./create-secrets.sh
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
helm repo add langfuse https://langfuse.github.io/langfuse-k8s
helm repo update
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
helm install langfuse langfuse/langfuse \
    -f values-openshift-single-user.yaml \
    --set langfuse.nextauth.url=$LANGFUSE_HOST
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
oc get pods
----

[.console-output]
[source,bash,subs=attributes+]
----
NAME                                            READY   STATUS    RESTARTS      AGE
fantaco-customer-main-7fd4ddb666-c26fv          1/1     Running   0             55m
fantaco-finance-main-75ffddb44b-frlxb           1/1     Running   0             55m
langfuse-clickhouse-shard0-0                    1/1     Running   0             23m
langfuse-postgresql-0                           1/1     Running   0             23m
langfuse-redis-primary-0                        1/1     Running   0             23m
langfuse-s3-5fb6c8f845-s9shp                    1/1     Running   0             23m
langfuse-web-67f4c9849-rmkxt                    1/1     Running   2 (23m ago)   23m
langfuse-worker-69d997664c-bdr8f                1/1     Running   0             23m
langfuse-zookeeper-0                            1/1     Running   0             23m
langgraph-fastapi-569d6d554-65j95               1/1     Running   0             55m
llamastack-distribution-vllm-78ccd8fcbf-tp2ch   1/1     Running   0             59m
mcp-customer-6bd8bcfc7b-fmmt2                   1/1     Running   0             55m
mcp-finance-8cc684b8d-bln8l                     1/1     Running   0             55m
postgresql-customer-ff78dffdf-69p5n             1/1     Running   0             55m
postgresql-finance-689d97894f-jlmm8             1/1     Running   0             55m
simple-agent-chat-ui-6d7794dc6b-4cndl           1/1     Running   0             55m
----

You can view logs of the worker or web pods.  There can be a few restarts while Kubernetes eventual consistency works its magic. 

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
oc logs -l app=web --tail=100
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
echo $LANGFUSE_URL
echo "Open in a new browser tab"
----

Use the GUI of Langfuse to then create the following:

* Account
* Organization
* Project
* API Keys

Click *Sign up*


image::langfuse-login-1.png[]

Provide name, email address and password and click *Sign up*

image::langfuse-sign-up-1.png[]

Click *New Organization*

image::langfuse-sign-up-2.png[]

Provide an organization name of *my-agent-org* and click *Create*

image::langfuse-sign-up-3.png[]

Click *Next*

image::langfuse-sign-up-4.png[]

Provide a project name of *my-agent-project* and click *Create*

image::langfuse-sign-up-5.png[]

Click on *Settings*

image::langfuse-sign-up-6.png[]

Click on *API Keys* 

image::langfuse-sign-up-7.png[]

Click on *+ Create new API Keys*

image::langfuse-sign-up-8.png[]

Provide a key name of *my-key* and click *Create API keys*

image::langfuse-sign-up-9.png[]

You will need the *.env* variables.  

image::langfuse-sign-up-10.png[]


Go back to the terminal and make sure you are in the correct directory

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
export LANGFUSE_SECRET_KEY=
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
export LANGFUSE_PUBLIC_KEY=
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
echo $LANGFUSE_SECRET_KEY
echo $LANGFUSE_PUBLIC_KEY
echo $LANGFUSE_HOST
----


[.console-output]
[source,bash,subs=attributes+]
----
sk-lf-66fa2f08-9797-4405-8a47-bbd295f8035c
pk-lf-827fb4cf-4d9b-41d3-a6fe-0bcd13aa5e6b
https://langfuse-agentic-user2.apps.cluster-l5k54.dynamic.redhatworkshops.io
----

== Test the agent

Terminal 1

Make sure you are in the backend directory 

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
cd $HOME/fantaco-redhat-one-2026/langfuse-setup/langgraph-agent/backend
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
pip install -r requirements.txt
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
python 6-langgraph-langfuse-fastapi-chatbot.py
----

[.console-output]
[source,bash,subs=attributes+]
----
2026-01-01 17:47:18,114 - __main__ - INFO - Starting FastAPI server on port 8002...
INFO:     Started server process [190]
INFO:     Waiting for application startup.
2026-01-01 17:47:18,167 - __main__ - INFO - Initializing MCP clients...
2026-01-01 17:47:18,374 - mcp.client.streamable_http - INFO - Received session ID: f551c9b09df343f1ad85ebd3b67dee48
2026-01-01 17:47:18,376 - mcp.client.streamable_http - INFO - Negotiated protocol version: 2025-06-18
2026-01-01 17:47:18,522 - mcp.client.streamable_http - INFO - Received session ID: 6d9eee0561334c05833355a3f9ac75e7
2026-01-01 17:47:18,524 - mcp.client.streamable_http - INFO - Negotiated protocol version: 2025-06-18
2026-01-01 17:47:18,599 - __main__ - INFO - MCP clients initialized. Available tools: ['search_customers', 'get_customer', 'fetch_order_history', 'fetch_invoice_history']
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8002 (Press CTRL+C to quit)
----

Terminal 2

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
curl -sS -X POST http://localhost:8002/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "who does Thomas Hardy work for?",
    "user_id": "test-user",
    "session_id": "test-session-123"
}' | jq -r '.reply'
----

[.console-output]
[source,bash,subs=attributes+]
----
Thomas Hardy works for **Around the Horn** as a **Sales Representative**. 

Let me know if you need additional details about this customer!
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
curl -sS -X POST http://localhost:8002/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "what are Fran Wilson'\''s orders?",
    "user_id": "test-user",
    "session_id": "test-session-123"
}' | jq -r '.reply'
----

[.console-output]
[source,bash,subs=attributes+]
----
Fran Wilson (LONEP) has 3 orders:

1. **ORD-006** (Jan 5, 2024) - DELIVERED $399.99  
2. **ORD-001** (Jan 15, 2024) - DELIVERED $299.99  
3. **ORD-002** (Jan 20, 2024) - SHIPPED $149.50  

Would you like details about any specific order or invoice history?
----

== Traces

Find the traces inside of Langfuse

image::langfuse-thomas-hardy.png[]

image::langfuse-fran-wilson.png[]

== Evals

The backend also provides a call to execute Langfuse Evals.  If you open up `6-langgraph-langfuse-fastapi-chatbot.py` you will find an endpoint defined via `@app.post("/evaluate", response_model=EvaluationResponse)`

And it in turn interacts with the Langfuse API to excute the evals.

----
  logger.info(f"Starting evaluation run: {request.run_name or 'auto-generated'}")
  result = await run_evaluation(
      test_cases_path=str(test_cases_path),
      process_chat_fn=process_chat,
      run_name=request.run_name,
      record_to_langfuse=request.record_to_langfuse
  )
----

Trigger the eval execution with a simple curl command

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
curl -sS -X POST http://localhost:8002/evaluate \
  -H "Content-Type: application/json" \
  -d '{
    "run_name": "after-prompt-update",
    "sync_dataset": true,
    "record_to_langfuse": true
  }' | jq .
----

[.console-output]
[source,bash,subs=attributes+]
----
{
  "run_name": "after-prompt-update",
  "timestamp": "2026-01-03T22:52:48.068633",
  "dataset_name": "customer-service-eval",
  "total_tests": 3,
  "passed": 3,
  "failed": 0,
  "pass_rate": 1.0,
  "average_score": 1.0,
  "duration_ms": 42144.819498062134,
  "results": [
    {
      "test_id": "thomas-hardy-company-job",
      "test_name": "Thomas Hardy Company and Job Query",
      "passed": true,
      "score": 1.0,
      "response": "\n\nThomas Hardy works for **Around the Horn** and his job title is **Sales Representative**. \n\nLet me know if you need additional details!",
      "trace_id": "ccbdd39f31ad0046995c2df51872d7ea",
      "matched_keywords": [
        "Around the Horn",
        "Sales Representative"
      ],
      "missing_keywords": [],
      "details": "Matched 2/2 keywords",
      "duration_ms": 8468.608140945435
    },
    {
      "test_id": "lonesome-pine-contact",
      "test_name": "Lonesome Pine Contact Query",
      "passed": true,
      "score": 1.0,
      "response": "\n\nThe primary contact for **Lonesome Pine Restaurant** is **Fran Wilson**, the Sales Manager. Hereâ€™s how to reach them:\n\n- **Phone:** (503) 555-9573  \n- **Email:** franwilson@example.com  \n\nLet me know if you need additional details!",
      "trace_id": "ccbdd39f31ad0046995c2df51872d7ea",
      "matched_keywords": [
        "Fran Wilson",
        "(503) 555-9573",
        "franwilson@example.com"
      ],
      "missing_keywords": [],
      "details": "Matched 3/3 keywords",
      "duration_ms": 10165.385484695435
    },
    {
      "test_id": "fran-wilson-delivered-orders",
      "test_name": "Fran Wilson Delivered Orders Query",
      "passed": true,
      "score": 1.0,
      "response": "\n\nHere are the delivered orders for Fran Wilson (LONEP):\n\n1. **Order #ORD-001**  \n   - Date: January 15, 2024  \n   - Total: $299.99  \n\n2. **Order #ORD-006**  \n   - Date: January 5, 2024  \n   - Total: $399.99  \n\n**Total delivered orders:** 2  \n*(Note: One additional order, ORD-002, is marked as \"SHIPPED\" but not yet delivered.)*  \n\nLet me know if you need further details!",
      "trace_id": "ccbdd39f31ad0046995c2df51872d7ea",
      "matched_keywords": [
        "ORD-001",
        "$299.99",
        "ORD-006",
        "$399.99"
      ],
      "missing_keywords": [],
      "details": "Matched 4/4 keywords",
      "duration_ms": 23384.660720825195
    }
  ]
}
----

image:langfuse-datasets-1.png[]

image:langfuse-datasets-4.png[]

image::langfuse-scores-1.png[]

image::langfuse-fran-wilson-delivered-orders-1.png[]



== Feedback

Note: Feedback requres access to the GUI and that requires the creation of a Route.

This step requires your Instructor with Cluster Admin permissions

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
source ./convert_url.sh 
----

[.console-output]
[source,bash,subs=attributes+]
----
CHAT_TRACE_URL=https://chatbot-8002-showroom-s5kx7-1-user1.apps.cluster-s5kx7.dynamic.redhatworkshops.io/
----

image::feedback-1.png[]

image::langfuse-scores-feedback-comment-1.png[]

image::langfuse-scores-feedback-comment-2.png[]

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
./list-traces.sh
----

[.console-output]
[source,bash,subs=attributes+]
----
Fetching last 10 traces...

TRACE ID                           QUERY
=====================================================================================
bc0008ba64304e09fcc3fbaf9f1f9888   what is today?
20a4d01e6cf0eb28e15872a5317274a2   who is Burr Sutter?
1e81a8782d937c8e1adafb994e96681c   what are the delivered orders for Fran Wilson?
dd4e1cb37e83e51e3d25bd05cc237f16   who is the primary contact for Lonesome Pine ...
631fc657a05762b86e44551393fb16f1   who does Thomas Hardy work for and what is hi...
4e4ed7ee062f0d38f0abb6fc03defc3d   what are the orders for Liu Wong?
017c454bb7fbc01cc5a7a8fe6f0b073b   who does Thomas Hardy work for?
8fa62c42a85d8f14ba9a42d38359ce53   what are Fran Wilson's orders?
5ee044f92e94fd50c133f5ac7dc82d96   who does Thomas Hardy work for?
----

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
./get-trace-feedback.sh bc0008ba64304e09fcc3fbaf9f1f9888
----

[.console-output]
[source,bash,subs=attributes+]
----
./get-trace-feedback.sh 

Fetching trace: bc0008ba64304e09fcc3fbaf9f1f9888
================================================
Name: customer-service-chat
Timestamp: 2026-01-08T17:57:16.111Z
Input: what is today?
Output:

I don't have access to real-time information or calendar functions. You'll need to check your device's clock or a calendar application for today's date. Let me know if you need help with any custome...

Feedback:
---------
  Score: thumbs down (0)
  Comment: you should have access to a clock~!
  Time: 2026-01-08T17:57:35.580Z
----

== Llama Stack integration


[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
cd ~/fantaco-redhat-one-2026/llama-stack-scripts
./update-llamastack-langfuse.sh $LANGFUSE_SECRET_KEY $LANGFUSE_PUBLIC_KEY $LANGFUSE_HOST
----

And watch for the pod to update

[.console-input]
[source,bash,role="copypaste",subs=attributes+]
----
oc get pods -l app=llama-stack
----





